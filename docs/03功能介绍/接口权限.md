# 接口权限

前排声明：

zeta-kotlin项目的接口权限设计参考自[lamp-boot](https://github.com/zuihou/lamp-boot) 项目



正文内容:

zeta-kotlin项目的增删改查功能设计因为参考了lamp项目，所以导致shiro和spring security的注解无法使用。

为什么呢？

因为不管是shiro的`@RequiresPermissions("xxxx")`还是spring security的`@PreAuthorize(hasAuthority='xxx')`注解都是写死的，无法动态改变

不是绝对，可能可以。我没仔细研究过

假如我在SaveController接口的save方法上加了`@PreAuthorize(hasAuthority='save')`注解

那么所有实现了SaveController接口的Controller类的save方法都只能由拥有save权限的用户访问。

举个例子：

用户管理Controller的save方法，只能由拥有`user:save`权限的用户才能访问。

但是因为SaveController的权限注解的关系，除非用户拥有save权限，不然无法访问接口。

所以现在我们期望得有一个注解，里面的内容是一个占位符 例如：`@Permissions("{}:save")` 

它注解在SaveController接口的save方法上。然后在用户管理的Controller类上有个注解用来配置权限的前缀 例如：`@Prefix("user")`

接口鉴权的时候，自动将前缀与占位符替换，得到`user:save`。 这样一来，拥有`user:save`权限的用户就能访问save接口了




## 如何实现接口权限

查看sa-token的源码可以知道，sa-token提供的StpUtil工具类里面拥有校验用户角色、权限的方法。

既然我们都接入了sa-token，那么我们就可以使用StpUtil工具类来判断当前登录的用户是否拥有某个角色或者某个权限

相关文档[sa-token权限认证](https://sa-token.dev33.cn/doc/index.html#/use/jur-auth)

sa-token其实也提供了权限认证相关的注解`@SaCheckRole("admin")`、`@SaCheckPermission("user:add")`等

我们是不是也可以仿照着lamp以及sa-token实现可以实现上面描述中的两个注解呢？

于是`org.zetaframework.core.saToken.annotation.PreAuth` 和 `org.zetaframework.core.saToken.annotation.PreCheckPermission`两个注解就这样诞生了

接口权限验证的实现可以看`org.zetaframework.core.saToken.aspect.PreCheckAspect`类


以上内容及到的类有：
```
/** zetaframework包 */
// 接口权限注解
org.zetaframework.core.saToken.annotation.PreAuth
org.zetaframework.core.saToken.annotation.PreCheckPermission
org.zetaframework.core.saToken.annotation.PreCheckRole
org.zetaframework.core.saToken.annotation.PreMode

// 接口权限aop
org.zetaframework.core.saToken.aspect
```
